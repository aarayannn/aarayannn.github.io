<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HINSA - Hybrid Intellegent System Agriculture Monitoring And Control Hydroponics </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2e7d32;
            --primary-light: #60ad5e;
            --primary-dark: #005005;
            --secondary: #f5f5f5;
            --accent: #ff8f00;
            --text: #212121;
            --text-light: #757575;
            --warning: #ff9800;
            --danger: #f44336;
            --success: #4caf50;
            --white: #ffffff;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background-color: #f9f9f9;
            font-size: 16px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background-color: var(--primary);
            color: var(--white);
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 1.8rem;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .main-content {
            padding: 2rem 0;
        }
        
        .card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--primary);
            color: var(--white);
            padding: 1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            scrollbar-width: thin;
        }
        
        .tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            white-space: nowrap;
            transition: var(--transition);
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary);
            color: var(--white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            transition: var(--transition);
        }
        
        .btn:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: #757575;
        }
        
        .btn-secondary:hover {
            background-color: #616161;
        }
        
        .btn-warning {
            background-color: var(--warning);
        }
        
        .btn-warning:hover {
            background-color: #f57c00;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .alert-success {
            background-color: #e8f5e9;
            color: var(--success);
            border-left: 4px solid var(--success);
        }
        
        .alert-warning {
            background-color: #fff8e1;
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }
        
        .alert-danger {
            background-color: #ffebee;
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 992px) {
            .grid-3 {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .grid-4 {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .sensor-card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            text-align: center;
            transition: var(--transition);
        }
        
        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .sensor-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .sensor-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .sensor-label {
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        .sensor-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .status-optimal {
            background-color: #e8f5e9;
            color: var(--success);
        }
        
        .status-warning {
            background-color: #fff8e1;
            color: var(--warning);
        }
        
        .status-danger {
            background-color: #ffebee;
            color: var(--danger);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1.5rem 0;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #e8f5e9;
            color: var(--success);
        }
        
        .badge-warning {
            background-color: #fff8e1;
            color: var(--warning);
        }
        
        .badge-danger {
            background-color: #ffebee;
            color: var(--danger);
        }
        
        .progress-container {
            background-color: #e0e0e0;
            border-radius: 50px;
            height: 8px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            border-radius: 50px;
            transition: width 0.5s ease;
        }
        
        .flex {
            display: flex;
        }
        
        .flex-between {
            justify-content: space-between;
        }
        
        .flex-center {
            justify-content: center;
            align-items: center;
        }
        
        .flex-column {
            flex-direction: column;
        }
        
        .gap-1 {
            gap: 0.5rem;
        }
        
        .gap-2 {
            gap: 1rem;
        }
        
        .mt-1 {
            margin-top: 0.5rem;
        }
        
        .mt-2 {
            margin-top: 1rem;
        }
        
        .mt-3 {
            margin-top: 1.5rem;
        }
        
        .mb-1 {
            margin-bottom: 0.5rem;
        }
        
        .mb-2 {
            margin-bottom: 1rem;
        }
        
        .mb-3 {
            margin-bottom: 1.5rem;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-primary {
            color: var(--primary);
        }
        
        .text-warning {
            color: var(--warning);
        }
        
        .text-danger {
            color: var(--danger);
        }
        
        .text-success {
            color: var(--success);
        }
        
        .text-muted {
            color: var(--text-light);
        }
        
        .fw-bold {
            font-weight: 700;
        }
        
        .fw-medium {
            font-weight: 500;
        }
        
        .board-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .board-option {
            flex: 1;
            min-width: 150px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .board-option:hover {
            border-color: #bdbdbd;
        }
        
        .board-option.selected {
            border-color: var(--primary);
            background-color: rgba(46, 125, 50, 0.05);
        }
        
        .board-option img {
            height: 60px;
            margin-bottom: 0.5rem;
        }
        
        .pin-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .pin-group {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
        }
        
        .pin-group h4 {
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: var(--primary);
        }
        
        .file-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .file-upload:hover {
            border-color: var(--primary);
        }
        
        .file-upload i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .file-upload p {
            margin-bottom: 0.5rem;
        }
        
        .file-upload input {
            display: none;
        }
        
        .data-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .week-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .week-option {
            flex: 1;
            min-width: 100px;
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .week-option:hover {
            background-color: #e0e0e0;
        }
        
        .week-option.active {
            background-color: var(--primary);
            color: var(--white);
        }
        
        .week-option h4 {
            margin: 0;
            font-size: 1rem;
        }
        
        .week-option p {
            margin: 0.25rem 0 0;
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        .parameter-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .parameter-table th, .parameter-table td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid #e0e0e0;
        }
        
        .parameter-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
        
        .parameter-table .optimal-value {
            font-weight: 700;
            color: var(--primary);
        }
        
        .harvest-notification {
            background-color: #fff8e1;
            border-left: 4px solid var(--warning);
            padding: 1rem;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .harvest-notification i {
            font-size: 2rem;
            color: var(--warning);
        }
        
        .control-panel {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .control-item:last-child {
            border-bottom: none;
        }
        
        .control-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .control-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-on {
            background-color: var(--success);
        }
        
        .status-off {
            background-color: #bdbdbd;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .firmware-code {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        footer {
            background-color: var(--primary);
            color: var(--white);
            padding: 2rem 0;
            margin-top: 2rem;
        }
        
        .footer-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .footer-content {
                flex-direction: row;
                justify-content: space-between;
            }
        }
        
        .footer-section h3 {
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .footer-links {
            list-style: none;
        }
        
        .footer-links li {
            margin-bottom: 0.5rem;
        }
        
        .footer-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .footer-links a:hover {
            color: var(--white);
        }
        
        .copyright {
            text-align: center;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .toast {
            background-color: var(--white);
            border-left: 4px solid var(--primary);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            max-width: 400px;
            animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards;
            position: relative;
        }
        
        .toast-success {
            border-left-color: var(--success);
        }
        
        .toast-warning {
            border-left-color: var(--warning);
        }
        
        .toast-error {
            border-left-color: var(--danger);
        }
        
        .toast-icon {
            font-size: 1.25rem;
        }
        
        .toast-success .toast-icon {
            color: var(--success);
        }
        
        .toast-warning .toast-icon {
            color: var(--warning);
        }
        
        .toast-error .toast-icon {
            color: var(--danger);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .toast-message {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .toast-progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 100%;
            animation: progress 3s linear forwards;
        }
        
        .toast-success .toast-progress-bar {
            background-color: var(--success);
        }
        
        .toast-warning .toast-progress-bar {
            background-color: var(--warning);
        }
        
        .toast-error .toast-progress-bar {
            background-color: var(--danger);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        @keyframes progress {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }
        
        /* Loader */
        .loader-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
        }
        
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
        <p>Memproses...</p>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <h1>HINSA - Hybrid Intellegent System Agriculture Monitoring And Control Hydroponic </h1>
                </div>
                <div>
                    <span style="opacity: 0.8;"> Platform Monitoring And Control Hydroponic berbasis Artificial Intellegent </span>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Dashboard -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-tachometer-alt"></i> Dashboard Monitoring</h2>
                    <div>
                        <span id="current-date-time"></span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="grid grid-4">
                        <div class="sensor-card">
                            <div class="sensor-icon">
                                <i class="fas fa-flask"></i>
                            </div>
                            <div class="sensor-label">PPM (Nutrisi)</div>
                            <div class="sensor-value" id="current-ppm">--</div>
                            <div class="sensor-status" id="ppm-status">Menunggu data...</div>
                        </div>
                        
                        <div class="sensor-card">
                            <div class="sensor-icon">
                                <i class="fas fa-vial"></i>
                            </div>
                            <div class="sensor-label">pH</div>
                            <div class="sensor-value" id="current-ph">--</div>
                            <div class="sensor-status" id="ph-status">Menunggu data...</div>
                        </div>
                        
                        <div class="sensor-card">
                            <div class="sensor-icon">
                                <i class="fas fa-calendar-day"></i>
                            </div>
                            <div class="sensor-label">Hari Pertumbuhan</div>
                            <div class="sensor-value" id="current-day">1</div>
                            <div class="sensor-status status-optimal">dari 25 hari</div>
                        </div>
                        
                        <div class="sensor-card">
                            <div class="sensor-icon">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div class="sensor-label">Suhu Air</div>
                            <div class="sensor-value" id="current-temp">--</div>
                            <div class="sensor-status" id="temp-status">Menunggu data...</div>
                        </div>
                    </div>
                    
                    <div class="progress-container mt-3">
                        <div class="progress-bar" id="growth-progress" style="width: 4%;"></div>
                    </div>
                    <div class="flex flex-between">
                        <span class="text-muted">Hari 1</span>
                        <span class="text-muted">Hari 25 (Panen)</span>
                    </div>
                    
                    <div id="harvest-notification" class="harvest-notification" style="display: none;">
                        <i class="fas fa-seedling"></i>
                        <div>
                            <h3>Siap Panen!</h3>
                            <p>Tanaman Pakcoy Anda telah mencapai hari ke-25 dan siap dipanen. Selamat!</p>
                        </div>
                    </div>
                    
                    <div class="chart-container mt-3">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Control Panel -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-sliders-h"></i> Panel Kontrol</h2>
                </div>
                <div class="card-body">
                    <div class="tabs">
                        <div class="tab active" data-tab="setup">Setup Perangkat</div>
                        <div class="tab" data-tab="analysis">Analisis Data</div>
                        <div class="tab" data-tab="control">Kontrol Perangkat</div>
                        <div class="tab" data-tab="firmware">Firmware & OTA</div>
                        <div class="tab" data-tab="export">Ekspor Data</div>
                    </div>
                    
                    <!-- Setup Tab -->
                    <div class="tab-content active" id="setup-tab">
                        <h3 class="mb-2">Pilih Jenis Board</h3>
                        <div class="board-selector">
                            <div class="board-option selected" data-board="esp32s3">
                                <img src="https://www.mouser.co.id/images/espressifsystems/images/ESP32-S3-DEVKITC-1-N8_SPL.jpg" alt="ESP32-S3">
                                <h4>ESP32-S3</h4>
                                <p class="text-muted">Direkomendasikan</p>
                            </div>
                            <div class="board-option" data-board="esp32">
                                <img src="https://adiy.in/wp-content/uploads/2024/03/1-1.jpg" alt="ESP32">
                                <h4>ESP32</h4>
                            </div>
                            <div class="board-option" data-board="esp8266">
                                <img src="https://adiy.in/wp-content/uploads/2024/03/1-1.jpg" alt="ESP8266">
                                <h4>ESP8266 / NodeMCU</h4>
                            </div>
                        </div>
                        
                        <h3 class="mb-2 mt-3">Konfigurasi Pin</h3>
                        <div class="grid">
                            <div class="pin-group">
                                <h4>Sensor PPM/TDS</h4>
                                <div class="form-group">
                                    <label for="ppm-pin">Pin Analog</label>
                                    <select id="ppm-pin">
                                        <option value="34">GPIO34 (ADC1_6)</option>
                                        <option value="35">GPIO35 (ADC1_7)</option>
                                        <option value="36">GPIO36 (ADC1_0)</option>
                                        <option value="39">GPIO39 (ADC1_3)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="pin-group">
                                <h4>Sensor pH</h4>
                                <div class="form-group">
                                    <label for="ph-pin">Pin Analog</label>
                                    <select id="ph-pin">
                                        <option value="35">GPIO35 (ADC1_7)</option>
                                        <option value="34">GPIO34 (ADC1_6)</option>
                                        <option value="36">GPIO36 (ADC1_0)</option>
                                        <option value="39">GPIO39 (ADC1_3)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="pin-group">
                                <h4>Pompa Nutrisi</h4>
                                <div class="form-group">
                                    <label for="nutrient-pin">Pin Digital</label>
                                    <select id="nutrient-pin">
                                        <option value="25">GPIO25</option>
                                        <option value="26">GPIO26</option>
                                        <option value="27">GPIO27</option>
                                        <option value="32">GPIO32</option>
                                        <option value="33">GPIO33</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="pin-group">
                                <h4>Pompa pH Up</h4>
                                <div class="form-group">
                                    <label for="ph-up-pin">Pin Digital</label>
                                    <select id="ph-up-pin">
                                        <option value="26">GPIO26</option>
                                        <option value="25">GPIO25</option>
                                        <option value="27">GPIO27</option>
                                        <option value="32">GPIO32</option>
                                        <option value="33">GPIO33</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="pin-group">
                                <h4>Pompa pH Down</h4>
                                <div class="form-group">
                                    <label for="ph-down-pin">Pin Digital</label>
                                    <select id="ph-down-pin">
                                        <option value="27">GPIO27</option>
                                        <option value="25">GPIO25</option>
                                        <option value="26">GPIO26</option>
                                        <option value="32">GPIO32</option>
                                        <option value="33">GPIO33</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="pin-group">
                                <h4>Sensor Suhu</h4>
                                <div class="form-group">
                                    <label for="temp-pin">Pin Digital</label>
                                    <select id="temp-pin">
                                        <option value="32">GPIO32</option>
                                        <option value="33">GPIO33</option>
                                        <option value="25">GPIO25</option>
                                        <option value="26">GPIO26</option>
                                        <option value="27">GPIO27</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mt-3">
                            <label for="wifi-ssid">WiFi SSID</label>
                            <input type="text" id="wifi-ssid" placeholder="Masukkan nama WiFi">
                        </div>
                        
                        <div class="form-group">
                            <label for="wifi-password">WiFi Password</label>
                            <input type="password" id="wifi-password" placeholder="Masukkan password WiFi">
                        </div>
                        
                        <button id="save-config-btn" class="btn btn-icon">
                            <i class="fas fa-save"></i> Simpan Konfigurasi
                        </button>
                    </div>
                    
                    <!-- Analysis Tab -->
                    <div class="tab-content" id="analysis-tab">
                        <h3 class="mb-2">Analisis Data 25 Hari</h3>
                        
                        <div class="week-selector">
                            <div class="week-option active" data-week="1">
                                <h4>Minggu 1</h4>
                                <p>Hari 1-7</p>
                            </div>
                            <div class="week-option" data-week="2">
                                <h4>Minggu 2</h4>
                                <p>Hari 8-14</p>
                            </div>
                            <div class="week-option" data-week="3">
                                <h4>Minggu 3</h4>
                                <p>Hari 15-21</p>
                            </div>
                            <div class="week-option" data-week="4">
                                <h4>Minggu 4</h4>
                                <p>Hari 22-25</p>
                            </div>
                        </div>
                        
                        <div class="parameter-table-container">
                            <table class="parameter-table">
                                <thead>
                                    <tr>
                                        <th>Minggu</th>
                                        <th>Hari</th>
                                        <th>PPM Optimal</th>
                                        <th>pH Optimal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>1-7</td>
                                        <td class="optimal-value">400-500</td>
                                        <td class="optimal-value">5.5-6.0</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>8-14</td>
                                        <td class="optimal-value">600-800</td>
                                        <td class="optimal-value">5.8-6.2</td>
                                    </tr>
                                    <tr>
                                        <td>3</td>
                                        <td>15-21</td>
                                        <td class="optimal-value">800-1000</td>
                                        <td class="optimal-value">6.0-6.3</td>
                                    </tr>
                                    <tr>
                                        <td>4</td>
                                        <td>22-25</td>
                                        <td class="optimal-value">1000-1200</td>
                                        <td class="optimal-value">6.0-6.5</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="grid mt-3">
                            <div>
                                <h3 class="mb-2">Input Manual</h3>
                                <div class="form-group">
                                    <label for="manual-ppm">Data PPM (pisahkan dengan koma)</label>
                                    <input type="text" id="manual-ppm" placeholder="Contoh: 450.5, 480.2, 420.8, 490.3">
                                </div>
                                <div class="form-group">
                                    <label for="manual-ph">Data pH (pisahkan dengan koma)</label>
                                    <input type="text" id="manual-ph" placeholder="Contoh: 5.72, 5.83, 5.91, 5.65">
                                </div>
                                <button id="analyze-manual-btn" class="btn btn-icon">
                                    <i class="fas fa-calculator"></i> Analisis Data
                                </button>
                            </div>
                            
                            <div>
                                <h3 class="mb-2">Import CSV</h3>
                                <div class="file-upload" id="csv-upload-container">
                                    <i class="fas fa-file-csv"></i>
                                    <p>Klik atau seret file CSV di sini</p>
                                    <span class="text-muted">Format: tanggal, ppm, ph, suhu</span>
                                    <input type="file" id="csv-file" accept=".csv">
                                </div>
                                <div class="data-preview" id="csv-preview" style="display: none;">
                                    <p>Data akan muncul di sini setelah file dipilih</p>
                                </div>
                                <button id="analyze-csv-btn" class="btn btn-icon mt-2" disabled>
                                    <i class="fas fa-chart-line"></i> Analisis CSV
                                </button>
                            </div>
                        </div>
                        
                        <div id="analysis-result" class="mt-3" style="display: none;">
                            <h3 class="mb-2">Hasil Analisis</h3>
                            <div class="grid">
                                <div class="card">
                                    <div class="card-header">
                                        <h2>Parameter Optimal</h2>
                                    </div>
                                    <div class="card-body">
                                        <div class="grid">
                                            <div>
                                                <h4>PPM (Nutrisi)</h4>
                                                <div class="sensor-value" id="result-ppm">450.5</div>
                                                <div class="sensor-status status-optimal" id="result-ppm-status">Optimal</div>
                                            </div>
                                            <div>
                                                <h4>pH</h4>
                                                <div class="sensor-value" id="result-ph">5.85</div>
                                                <div class="sensor-status status-optimal" id="result-ph-status">Optimal</div>
                                            </div>
                                        </div>
                                        <div class="alert alert-success mt-2">
                                            <i class="fas fa-info-circle"></i>
                                            <div id="analysis-decision">Semua parameter dalam range optimal</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header">
                                        <h2>Rekomendasi 25 Hari</h2>
                                    </div>
                                    <div class="card-body">
                                        <p>Berdasarkan analisis, berikut rekomendasi parameter untuk 25 hari:</p>
                                        <div class="table-container mt-2">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Hari</th>
                                                        <th>PPM</th>
                                                        <th>pH</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="recommendation-table">
                                                    <!-- Filled by JavaScript -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <button id="upload-recommendation-btn" class="btn btn-icon mt-2">
                                            <i class="fas fa-upload"></i> Upload ke Perangkat
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Control Tab -->
                    <div class="tab-content" id="control-tab">
                        <div class="grid">
                            <div>
                                <h3 class="mb-2">Koneksi Perangkat</h3>
                                <div class="form-group">
                                    <label for="device-ip">Alamat IP Perangkat</label>
                                    <input type="text" id="device-ip" placeholder="Contoh: 192.168.1.100">
                                </div>
                                <div class="form-group">
                                    <label for="device-port">Port</label>
                                    <input type="number" id="device-port" value="80">
                                </div>
                                <div class="btn-group">
                                    <button id="connect-btn" class="btn btn-icon">
                                        <i class="fas fa-wifi"></i> Hubungkan
                                    </button>
                                    <button id="disconnect-btn" class="btn btn-secondary btn-icon" disabled>
                                        <i class="fas fa-power-off"></i> Putuskan
                                    </button>
                                </div>
                                <div id="connection-status" class="alert alert-warning mt-2" style="display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <div>Tidak terhubung ke perangkat</div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="mb-2">Pengaturan Hari</h3>
                                <div class="form-group">
                                    <label for="day-input">Hari Ke-</label>
                                    <input type="number" id="day-input" min="1" max="25" value="1">
                                </div>
                                <p class="text-muted mb-2">Atur hari pertumbuhan tanaman (1-25)</p>
                                <button id="set-day-btn" class="btn btn-icon" disabled>
                                    <i class="fas fa-calendar-check"></i> Atur Hari
                                </button>
                                <button id="reset-day-btn" class="btn btn-warning btn-icon mt-2" disabled>
                                    <i class="fas fa-redo"></i> Reset ke Hari 1
                                </button>
                            </div>
                        </div>
                        
                        <div class="control-panel mt-3">
                            <h3 class="mb-2">Kontrol Manual Perangkat</h3>
                            
                            <div class="control-item">
                                <div class="control-label">
                                    <span class="control-status" id="auto-status"></span>
                                    Mode Otomatis
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-toggle" checked disabled>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="control-item">
                                <div class="control-label">
                                    <span class="control-status" id="nutrient-status"></span>
                                    Pompa Nutrisi
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="nutrient-toggle" disabled>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="control-item">
                                <div class="control-label">
                                    <span class="control-status" id="ph-up-status"></span>
                                    Pompa pH Up
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="ph-up-toggle" disabled>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <div class="control-item">
                                <div class="control-label">
                                    <span class="control-status" id="ph-down-status"></span>
                                    Pompa pH Down
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="ph-down-toggle" disabled>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h3 class="mb-2">Parameter Saat Ini</h3>
                            <div class="grid">
                                <div class="form-group">
                                    <label for="current-ppm-min">PPM Minimum</label>
                                    <input type="number" id="current-ppm-min" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="current-ppm-max">PPM Maksimum</label>
                                    <input type="number" id="current-ppm-max" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="current-ph-min">pH Minimum</label>
                                    <input type="number" id="current-ph-min" step="0.1" disabled>
                                </div>
                                <div class="form-group">
                                    <label for="current-ph-max">pH Maksimum</label>
                                    <input type="number" id="current-ph-max" step="0.1" disabled>
                                </div>
                            </div>
                            <button id="send-params-btn" class="btn btn-icon mt-2" disabled>
                                <i class="fas fa-paper-plane"></i> Kirim Parameter ke Perangkat
                            </button>
                        </div>
                    </div>
                    
                    <!-- Firmware Tab -->
                    <div class="tab-content" id="firmware-tab">
                        <div class="grid">
                            <div>
                                <h3 class="mb-2">OTA Update</h3>
                                <div class="form-group">
                                    <label for="ota-file">File Firmware (.bin)</label>
                                    <input type="file" id="ota-file" accept=".bin">
                                </div>
                                <p class="text-muted mb-2">Pilih file firmware (.bin) untuk diupload ke perangkat</p>
                                <button id="ota-btn" class="btn btn-warning btn-icon" disabled>
                                    <i class="fas fa-upload"></i> Update OTA
                                </button>
                                <div id="ota-status" class="alert alert-success mt-2" style="display: none;">
                                    <i class="fas fa-check-circle"></i>
                                    <div>Update berhasil! Perangkat akan restart.</div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="mb-2">Konversi CSV ke Firmware</h3>
                                <div class="file-upload" id="csv-to-bin-container">
                                    <i class="fas fa-file-csv"></i>
                                    <p>Klik atau seret file CSV di sini</p>
                                    <span class="text-muted">File CSV hasil analisis</span>
                                    <input type="file" id="csv-to-bin-file" accept=".csv">
                                </div>
                                <button id="convert-to-bin-btn" class="btn btn-icon mt-2" disabled>
                                    <i class="fas fa-cogs"></i> Konversi ke .bin
                                </button>
                                <button id="download-bin-btn" class="btn btn-secondary btn-icon mt-2" disabled>
                                    <i class="fas fa-download"></i> Download .bin
                                </button>
                            </div>
                        </div>
                        
                        <h3 class="mb-2 mt-3">Firmware ESP32-S3</h3>
                        <p class="mb-2">Kode firmware untuk ESP32-S3 dengan konfigurasi saat ini:</p>
                        <div class="firmware-code" id="firmware-code">
// Kode firmware akan muncul di sini setelah konfigurasi disimpan
                        </div>
                        <div class="btn-group mt-2">
                            <button id="copy-firmware-btn" class="btn btn-secondary btn-icon">
                                <i class="fas fa-copy"></i> Salin Kode
                            </button>
                            <button id="download-firmware-btn" class="btn btn-secondary btn-icon">
                                <i class="fas fa-download"></i> Download sebagai File
                            </button>
                        </div>
                    </div>
                    
                    <!-- Export Tab -->
                    <div class="tab-content" id="export-tab">
                        <h3 class="mb-2">Ekspor Data Monitoring</h3>
                        <p>Ekspor data monitoring untuk analisis lebih lanjut atau dokumentasi:</p>
                        
                        <div class="grid mt-3">
                            <div class="card">
                                <div class="card-header">
                                    <h2>Data Harian</h2>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="export-date-range">Rentang Tanggal</label>
                                        <select id="export-date-range">
                                            <option value="today">Hari Ini</option>
                                            <option value="week">7 Hari Terakhir</option>
                                            <option value="month">30 Hari Terakhir</option>
                                            <option value="all">Semua Data</option>
                                        </select>
                                    </div>
                                    <div class="btn-group mt-2">
                                        <button id="export-csv-btn" class="btn btn-secondary btn-icon">
                                            <i class="fas fa-file-csv"></i> Ekspor CSV
                                        </button>
                                        <button id="export-json-btn" class="btn btn-secondary btn-icon">
                                            <i class="fas fa-file-code"></i> Ekspor JSON
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h2>Laporan Panen</h2>
                                </div>
                                <div class="card-body">
                                    <p>Buat laporan lengkap setelah panen:</p>
                                    <div class="form-group mt-2">
                                        <label for="harvest-notes">Catatan Panen</label>
                                        <textarea id="harvest-notes" rows="3" placeholder="Masukkan catatan tentang hasil panen..."></textarea>
                                    </div>
                                    <button id="generate-report-btn" class="btn btn-icon mt-2">
                                        <i class="fas fa-file-alt"></i> Buat Laporan Panen
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h2>Pratinjau Data</h2>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Tanggal</th>
                                                <th>Waktu</th>
                                                <th>Hari Ke</th>
                                                <th>PPM</th>
                                                <th>pH</th>
                                                <th>Suhu</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="data-preview-table">
                                            <tr>
                                                <td colspan="7" class="text-center">Tidak ada data untuk ditampilkan</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>HINSA</h3>
                    <p>Sistem Monitoring Hidroponik Cerdas untuk petani modern.</p>
                </div>
                
                <div class="footer-section">
                    <h3>Tautan</h3>
                    <ul class="footer-links">
                        <li><a href="#">Beranda</a></li>
                        <li><a href="#">Dokumentasi</a></li>
                        <li><a href="#">Panduan Pengguna</a></li>
                        <li><a href="#">FAQ</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Kontak</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-envelope"></i> info@hinsa.id</a></li>
                        <li><a href="#"><i class="fas fa-phone"></i> +62 812 3456 7890</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                &copy; 2025 HINSA - Sistem Monitoring Hidroponik Cerdas. All rights reserved.
            </div>
        </div>
    </footer>
    
    <!-- JavaScript -->
    <script>
        // Global variables
        const weekParameters = {
            1: { ppmMin: 400, ppmMax: 500, phMin: 5.5, phMax: 6.0 },
            2: { ppmMin: 600, ppmMax: 800, phMin: 5.8, phMax: 6.2 },
            3: { ppmMin: 800, ppmMax: 1000, phMin: 6.0, phMax: 6.3 },
            4: { ppmMin: 1000, ppmMax: 1200, phMin: 6.0, phMax: 6.5 }
        };
        
        let currentWeek = 1;
        let currentDay = 1;
        let deviceConnected = false;
        let csvData = null;
        let growthChart = null;
        let recommendationData = [];
        let selectedBoard = 'esp32s3';
        
        // DOM Elements
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const weekOptions = document.querySelectorAll('.week-option');
        const boardOptions = document.querySelectorAll('.board-option');
        const currentDateTimeEl = document.getElementById('current-date-time');
        const growthProgressEl = document.getElementById('growth-progress');
        const harvestNotificationEl = document.getElementById('harvest-notification');
        const currentPpmEl = document.getElementById('current-ppm');
        const currentPhEl = document.getElementById('current-ph');
        const currentDayEl = document.getElementById('current-day');
        const currentTempEl = document.getElementById('current-temp');
        const ppmStatusEl = document.getElementById('ppm-status');
        const phStatusEl = document.getElementById('ph-status');
        const tempStatusEl = document.getElementById('temp-status');
        const csvFileInput = document.getElementById('csv-file');
        const csvPreviewEl = document.getElementById('csv-preview');
        const analyzeCsvBtn = document.getElementById('analyze-csv-btn');
        const analyzeManualBtn = document.getElementById('analyze-manual-btn');
        const manualPpmInput = document.getElementById('manual-ppm');
        const manualPhInput = document.getElementById('manual-ph');
        const analysisResultEl = document.getElementById('analysis-result');
        const resultPpmEl = document.getElementById('result-ppm');
        const resultPhEl = document.getElementById('result-ph');
        const resultPpmStatusEl = document.getElementById('result-ppm-status');
        const resultPhStatusEl = document.getElementById('result-ph-status');
        const analysisDecisionEl = document.getElementById('analysis-decision');
        const recommendationTableEl = document.getElementById('recommendation-table');
        const uploadRecommendationBtn = document.getElementById('upload-recommendation-btn');
        const deviceIpInput = document.getElementById('device-ip');
        const devicePortInput = document.getElementById('device-port');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const connectionStatusEl = document.getElementById('connection-status');
        const dayInput = document.getElementById('day-input');
        const setDayBtn = document.getElementById('set-day-btn');
        const resetDayBtn = document.getElementById('reset-day-btn');
        const autoToggle = document.getElementById('auto-toggle');
        const nutrientToggle = document.getElementById('nutrient-toggle');
        const phUpToggle = document.getElementById('ph-up-toggle');
        const phDownToggle = document.getElementById('ph-down-toggle');
        const autoStatusEl = document.getElementById('auto-status');
        const nutrientStatusEl = document.getElementById('nutrient-status');
        const phUpStatusEl = document.getElementById('ph-up-status');
        const phDownStatusEl = document.getElementById('ph-down-status');
        const currentPpmMinInput = document.getElementById('current-ppm-min');
        const currentPpmMaxInput = document.getElementById('current-ppm-max');
        const currentPhMinInput = document.getElementById('current-ph-min');
        const currentPhMaxInput = document.getElementById('current-ph-max');
        const sendParamsBtn = document.getElementById('send-params-btn');
        const otaFileInput = document.getElementById('ota-file');
        const otaBtn = document.getElementById('ota-btn');
        const otaStatusEl = document.getElementById('ota-status');
        const csvToBinFileInput = document.getElementById('csv-to-bin-file');
        const convertToBinBtn = document.getElementById('convert-to-bin-btn');
        const downloadBinBtn = document.getElementById('download-bin-btn');
        const firmwareCodeEl = document.getElementById('firmware-code');
        const copyFirmwareBtn = document.getElementById('copy-firmware-btn');
        const downloadFirmwareBtn = document.getElementById('download-firmware-btn');
        const exportDateRangeSelect = document.getElementById('export-date-range');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const harvestNotesTextarea = document.getElementById('harvest-notes');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const dataPreviewTableEl = document.getElementById('data-preview-table');
        const saveConfigBtn = document.getElementById('save-config-btn');
        const loaderEl = document.getElementById('loader');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', init);
        
        function init() {
            setupEventListeners();
            updateDateTime();
            renderGrowthChart();
            simulateSensorData();
            setInterval(updateDateTime, 1000);
            setInterval(simulateSensorData, 5000);
            
            // Show welcome toast
            setTimeout(() => {
                showToast('Selamat datang di HINSA - Sistem Monitoring Hidroponik Cerdas', 'success');
            }, 1000);
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Update tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Update content
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Week selection
            weekOptions.forEach(option => {
                option.addEventListener('click', function() {
                    weekOptions.forEach(w => w.classList.remove('active'));
                    this.classList.add('active');
                    currentWeek = parseInt(this.dataset.week);
                    updateDayRange();
                });
            });
            
            // Board selection
            boardOptions.forEach(option => {
                option.addEventListener('click', function() {
                    boardOptions.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedBoard = this.dataset.board;
                    updatePinOptions();
                });
            });
            
            // CSV file upload
            csvFileInput.addEventListener('change', handleCSVUpload);
            document.getElementById('csv-upload-container').addEventListener('click', function() {
                csvFileInput.click();
            });
            
            // CSV to BIN file upload
            csvToBinFileInput.addEventListener('change', handleCSVToBinUpload);
            document.getElementById('csv-to-bin-container').addEventListener('click', function() {
                csvToBinFileInput.click();
            });
            
            // Analysis buttons
            analyzeManualBtn.addEventListener('click', analyzeManualData);
            analyzeCsvBtn.addEventListener('click', analyzeCSVData);
            uploadRecommendationBtn.addEventListener('click', uploadRecommendation);
            
            // Device connection
            connectBtn.addEventListener('click', connectToDevice);
            disconnectBtn.addEventListener('click', disconnectFromDevice);
            
            // Device control
            setDayBtn.addEventListener('click', setDay);
            resetDayBtn.addEventListener('click', resetDay);
            sendParamsBtn.addEventListener('click', sendParameters);
            
            // Device toggles
            autoToggle.addEventListener('change', toggleAuto);
            nutrientToggle.addEventListener('change', toggleNutrient);
            phUpToggle.addEventListener('change', togglePhUp);
            phDownToggle.addEventListener('change', togglePhDown);
            
            // OTA update
            otaBtn.addEventListener('click', performOtaUpdate);
            convertToBinBtn.addEventListener('click', convertToBin);
            downloadBinBtn.addEventListener('click', downloadBin);
            
            // Firmware actions
            copyFirmwareBtn.addEventListener('click', copyFirmwareCode);
            downloadFirmwareBtn.addEventListener('click', downloadFirmware);
            saveConfigBtn.addEventListener('click', saveConfiguration);
            
            // Export actions
            exportCsvBtn.addEventListener('click', exportToCsv);
            exportJsonBtn.addEventListener('click', exportToJson);
            generateReportBtn.addEventListener('click', generateReport);
        }
        
        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            currentDateTimeEl.textContent = now.toLocaleDateString('id-ID', options);
        }
        
        // Update day range based on selected week
        function updateDayRange() {
            let minDay = 1, maxDay = 7;
            
            if (currentWeek === 2) {
                minDay = 8;
                maxDay = 14;
            } else if (currentWeek === 3) {
                minDay = 15;
                maxDay = 21;
            } else if (currentWeek === 4) {
                minDay = 22;
                maxDay = 25;
            }
            
            dayInput.min = minDay;
            dayInput.max = maxDay;
            
            // Update parameters display
            const params = weekParameters[currentWeek];
            currentPpmMinInput.value = params.ppmMin;
            currentPpmMaxInput.value = params.ppmMax;
            currentPhMinInput.value = params.phMin;
            currentPhMaxInput.value = params.phMax;
        }
        
        // Update pin options based on selected board
        function updatePinOptions() {
            // This would be implemented to change available pins based on board selection
            console.log(`Board changed to: ${selectedBoard}`);
            
            // For demonstration, we'll just show a message
            showToast(`Board changed to ${selectedBoard.toUpperCase()}`, 'success');
        }
        
        // Handle CSV file upload
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            csvPreviewEl.style.display = 'block';
            csvPreviewEl.innerHTML = "<p>Memproses file CSV...</p>";
            analyzeCsvBtn.disabled = true;
            
            // Simulate CSV parsing
            setTimeout(() => {
                csvData = [
                    { date: '2025-05-10', ppm: '450.5', ph: '5.72', temp: '25.3' },
                    { date: '2025-05-11', ppm: '480.2', ph: '5.83', temp: '25.1' },
                    { date: '2025-05-12', ppm: '420.8', ph: '5.91', temp: '24.8' }
                ];
                
                // Display sample data
                let previewHTML = `<p>Data CSV (${csvData.length} baris):</p>`;
                previewHTML += `<div class="table-container"><table>
                    <tr><th>Tanggal</th><th>PPM</th><th>pH</th><th>Suhu</th></tr>`;
                
                // Show rows
                for (const row of csvData) {
                    previewHTML += `<tr>
                        <td>${row.date}</td>
                        <td>${row.ppm}</td>
                        <td>${row.ph}</td>
                        <td>${row.temp}</td>
                    </tr>`;
                }
                
                previewHTML += "</table></div>";
                csvPreviewEl.innerHTML = previewHTML;
                
                analyzeCsvBtn.disabled = false;
                showToast('File CSV berhasil diproses', 'success');
            }, 1000);
        }
        
        // Handle CSV to BIN file upload
        function handleCSVToBinUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            convertToBinBtn.disabled = false;
            showToast('File CSV berhasil diunggah', 'success');
        }
        
        // Analyze manual data
        function analyzeManualData() {
            const ppmValues = parseInputValues(manualPpmInput.value);
            const phValues = parseInputValues(manualPhInput.value);
            
            if (ppmValues.length === 0 || phValues.length === 0) {
                showToast('Masukkan data PPM dan pH yang valid!', 'warning');
                return;
            }
            
            performAnalysis(ppmValues, phValues);
        }
        
        // Analyze CSV data
        function analyzeCSVData() {
            if (!csvData) {
                showToast('Tidak ada data CSV yang valid untuk dianalisis', 'warning');
                return;
            }
            
            // Extract ppm and ph values
            const ppmValues = csvData.map(row => parseFloat(row.ppm));
            const phValues = csvData.map(row => parseFloat(row.ph));
            
            performAnalysis(ppmValues, phValues);
        }
        
        // Perform analysis on data
        function performAnalysis(ppmValues, phValues) {
            showLoader();
            
            setTimeout(() => {
                const params = weekParameters[currentWeek];
                
                // Calculate median values (more robust than average)
                const medianPpm = calculateMedian(ppmValues);
                const medianPh = calculateMedian(phValues);
                
                // Apply decision tree analysis
                const ppmAnalysis = analyzeWithDecisionTree(currentWeek, ppmValues, 'ppm');
                const phAnalysis = analyzeWithDecisionTree(currentWeek, phValues, 'ph');
                
                // Adjust to optimal range with decision tree recommendations
                const optimalPpm = Math.max(params.ppmMin, Math.min(params.ppmMax, medianPpm + ppmAnalysis.adjustment));
                const optimalPh = Math.max(params.phMin, Math.min(params.phMax, medianPh + phAnalysis.adjustment));
                
                // Generate 25-day recommendation
                generateRecommendation(optimalPpm, optimalPh);
                
                // Display results
                showResults(optimalPpm, optimalPh, ppmAnalysis, phAnalysis);
                
                hideLoader();
                showToast('Analisis data selesai', 'success');
            }, 1000);
        }
        
        // Generate 25-day recommendation
        function generateRecommendation(basePpm, basePh) {
            recommendationData = [];
            
            // Calculate gradual increase for each day
            for (let day = 1; day <= 25; day++) {
                let week = 1;
                if (day > 7 && day <= 14) week = 2;
                else if (day > 14 && day <= 21) week = 3;
                else if (day > 21) week = 4;
                
                const params = weekParameters[week];
                
                // Calculate target values for this day
                // We'll use a linear interpolation within each week
                let targetPpm, targetPh;
                
                if (week === 1) {
                    // Week 1: Start with base values and gradually increase
                    const progress = (day - 1) / 6; // 0 to 1 over 7 days
                    targetPpm = basePpm + progress * (weekParameters[2].ppmMin - basePpm);
                    targetPh = basePh + progress * (weekParameters[2].phMin - basePh);
                } else {
                    // Other weeks: Interpolate between min and max of the week
                    const daysInWeek = week === 4 ? 4 : 7;
                    const startDay = (week - 1) * 7 + 1;
                    const progress = (day - startDay) / (daysInWeek - 1);
                    targetPpm = params.ppmMin + progress * (params.ppmMax - params.ppmMin);
                    targetPh = params.phMin + progress * (params.phMax - params.phMin);
                }
                
                recommendationData.push({
                    day,
                    ppm: Math.round(targetPpm),
                    ph: parseFloat(targetPh.toFixed(2))
                });
            }
            
            // Update recommendation table
            let tableHTML = '';
            for (const data of recommendationData) {
                tableHTML += `
                <tr>
                    <td>${data.day}</td>
                    <td>${data.ppm}</td>
                    <td>${data.ph}</td>
                </tr>`;
            }
            recommendationTableEl.innerHTML = tableHTML;
        }
        
        // Show analysis results
        function showResults(optimalPpm, optimalPh, ppmAnalysis, phAnalysis) {
            // Format numbers to show 1 decimal place for PPM and 2 for pH
            resultPpmEl.textContent = optimalPpm.toFixed(1);
            resultPhEl.textContent = optimalPh.toFixed(2);
            
            // Display status badges
            resultPpmStatusEl.textContent = ppmAnalysis.status === "optimal" ? "Optimal" : 
                                         ppmAnalysis.status === "warning" ? "Perhatian" : "Kritis";
            resultPpmStatusEl.className = `sensor-status status-${ppmAnalysis.status}`;
            
            resultPhStatusEl.textContent = phAnalysis.status === "optimal" ? "Optimal" : 
                                        phAnalysis.status === "warning" ? "Perhatian" : "Kritis";
            resultPhStatusEl.className = `sensor-status status-${phAnalysis.status}`;
            
            // Display decision tree analysis
            const decisions = [];
            if (ppmAnalysis.decision !== "Parameter dalam range optimal") {
                decisions.push(`PPM: ${ppmAnalysis.decision}`);
            }
            if (phAnalysis.decision !== "Parameter dalam range optimal") {
                decisions.push(`pH: ${phAnalysis.decision}`);
            }
            
            if (decisions.length > 0) {
                analysisDecisionEl.textContent = decisions.join(" | ");
            } else {
                analysisDecisionEl.textContent = "Semua parameter dalam range optimal";
            }
            
            // Show results section
            analysisResultEl.style.display = 'block';
            
            // Scroll to results
            analysisResultEl.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Decision Tree Algorithm
        function analyzeWithDecisionTree(week, values, parameter) {
            const params = weekParameters[week];
            const min = parameter === 'ppm' ? params.ppmMin : params.phMin;
            const max = parameter === 'ppm' ? params.ppmMax : params.phMax;
            
            // Calculate statistics
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const range = Math.max(...values) - Math.min(...values);
            const stability = range / (max - min);
            
            // Decision tree rules
            if (values.some(v => v < min * 0.8 || v > max * 1.2)) {
                return {
                    decision: "Terdapat nilai ekstrim yang perlu diperiksa",
                    adjustment: 0,
                    confidence: "rendah",
                    status: "danger"
                };
            } else if (stability > 0.5) {
                return {
                    decision: "Parameter tidak stabil, perlu penyesuaian",
                    adjustment: (avg - (min + max)/2) * 0.5,
                    confidence: "sedang",
                    status: "warning"
                };
            } else if (avg < min) {
                return {
                    decision: "Parameter terlalu rendah, perlu dinaikkan",
                    adjustment: (min - avg) * 0.7,
                    confidence: "tinggi",
                    status: "warning"
                };
            } else if (avg > max) {
                return {
                    decision: "Parameter terlalu tinggi, perlu diturunkan",
                    adjustment: (max - avg) * 0.7,
                    confidence: "tinggi",
                    status: "warning"
                };
            } else {
                return {
                    decision: "Parameter dalam range optimal",
                    adjustment: 0,
                    confidence: "tinggi",
                    status: "optimal"
                };
            }
        }
        
        // Upload recommendation to device
        function uploadRecommendation() {
            if (!deviceConnected) {
                showToast('Hubungkan ke perangkat terlebih dahulu', 'warning');
                return;
            }
            
            showLoader();
            
            setTimeout(() => {
                hideLoader();
                showToast('Rekomendasi berhasil diunggah ke perangkat', 'success');
            }, 1500);
        }
        
        // Connect to device
        function connectToDevice() {
            const ip = deviceIpInput.value.trim();
            const port = devicePortInput.value.trim();
            
            if (!ip) {
                showToast('Masukkan alamat IP perangkat!', 'warning');
                return;
            }
            
            showLoader();
            
            setTimeout(() => {
                deviceConnected = true;
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                setDayBtn.disabled = false;
                resetDayBtn.disabled = false;
                autoToggle.disabled = false;
                nutrientToggle.disabled = false;
                phUpToggle.disabled = false;
                phDownToggle.disabled = false;
                sendParamsBtn.disabled = false;
                otaBtn.disabled = false;
                
                // Update connection status
                connectionStatusEl.style.display = 'block';
                connectionStatusEl.className = 'alert alert-success';
                connectionStatusEl.innerHTML = '<i class="fas fa-check-circle"></i><div>Terhubung ke perangkat</div>';
                
                // Update control status indicators
                autoStatusEl.className = 'control-status status-on';
                nutrientStatusEl.className = 'control-status status-off';
                phUpStatusEl.className = 'control-status status-off';
                phDownStatusEl.className = 'control-status status-off';
                
                hideLoader();
                showToast(`Terhubung ke perangkat di ${ip}:${port}`, 'success');
            }, 1500);
        }
        
        // Disconnect from device
        function disconnectFromDevice() {
            showLoader();
            
            setTimeout(() => {
                deviceConnected = false;
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                setDayBtn.disabled = true;
                resetDayBtn.disabled = true;
                autoToggle.disabled = true;
                nutrientToggle.disabled = true;
                phUpToggle.disabled = true;
                phDownToggle.disabled = true;
                sendParamsBtn.disabled = true;
                otaBtn.disabled = true;
                
                // Update connection status
                connectionStatusEl.style.display = 'block';
                connectionStatusEl.className = 'alert alert-warning';
                connectionStatusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i><div>Tidak terhubung ke perangkat</div>';
                
                hideLoader();
                showToast('Koneksi ke perangkat diputus', 'warning');
            }, 1000);
        }
        
        // Set day
        function setDay() {
            const day = parseInt(dayInput.value);
            
            if (day < 1 || day > 25) {
                showToast('Masukkan nilai hari yang valid (1-25)', 'warning');
                return;
            }
            
            showLoader();
            
            setTimeout(() => {
                currentDay = day;
                currentDayEl.textContent = day;
                
                // Update growth progress
                const progress = (day / 25) * 100;
                growthProgressEl.style.width = `${progress}%`;
                
                // Show/hide harvest notification
                harvestNotificationEl.style.display = day >= 25 ? 'flex' : 'none';
                
                hideLoader();
                showToast(`Hari pertumbuhan diatur ke hari ${day}`, 'success');
            }, 1000);
        }
        
        // Reset day to 1
        function resetDay() {
            showLoader();
            
            setTimeout(() => {
                currentDay = 1;
                currentDayEl.textContent = 1;
                dayInput.value = 1;
                
                // Update growth progress
                growthProgressEl.style.width = '4%';
                
                // Hide harvest notification
                harvestNotificationEl.style.display = 'none';
                
                hideLoader();
                showToast('Hari pertumbuhan direset ke hari 1', 'success');
            }, 1000);
        }
        
        // Send parameters to device
        function sendParameters() {
            showLoader();
            
            setTimeout(() => {
                hideLoader();
                showToast('Parameter berhasil dikirim ke perangkat', 'success');
            }, 1000);
        }
        
        // Toggle auto mode
        function toggleAuto() {
            autoStatusEl.className = autoToggle.checked ? 'control-status status-on' : 'control-status status-off';
            
            // Enable/disable manual controls based on auto mode
            const manualControlsDisabled = autoToggle.checked || !deviceConnected;
            nutrientToggle.disabled = manualControlsDisabled;
            phUpToggle.disabled = manualControlsDisabled;
            phDownToggle.disabled = manualControlsDisabled;
            
            showToast(`Mode ${autoToggle.checked ? 'Otomatis' : 'Manual'} diaktifkan`, 'success');
        }
        
        // Toggle nutrient pump
        function toggleNutrient() {
            nutrientStatusEl.className = nutrientToggle.checked ? 'control-status status-on' : 'control-status status-off';
            showToast(`Pompa Nutrisi ${nutrientToggle.checked ? 'Aktif' : 'Nonaktif'}`, 'success');
        }
        
        // Toggle pH up pump
        function togglePhUp() {
            phUpStatusEl.className = phUpToggle.checked ? 'control-status status-on' : 'control-status status-off';
            
            if (phUpToggle.checked && phDownToggle.checked) {
                phDownToggle.checked = false;
                phDownStatusEl.className = 'control-status status-off';
            }
            
            showToast(`Pompa pH Up ${phUpToggle.checked ? 'Aktif' : 'Nonaktif'}`, 'success');
        }
        
        // Toggle pH down pump
        function togglePhDown() {
            phDownStatusEl.className = phDownToggle.checked ? 'control-status status-on' : 'control-status status-off';
            
            if (phDownToggle.checked && phUpToggle.checked) {
                phUpToggle.checked = false;
                phUpStatusEl.className = 'control-status status-off';
            }
            
            showToast(`Pompa pH Down ${phDownToggle.checked ? 'Aktif' : 'Nonaktif'}`, 'success');
        }
        
        // Perform OTA update
        function performOtaUpdate() {
            const file = otaFileInput.files[0];
            
            if (!file) {
                showToast('Pilih file firmware terlebih dahulu', 'warning');
                return;
            }
            
            showLoader();
            
            setTimeout(() => {
                otaStatusEl.style.display = 'block';
                otaStatusEl.innerHTML = '<i class="fas fa-check-circle"></i><div>Update berhasil! Perangkat akan restart.</div>';
                
                hideLoader();
                showToast('Firmware berhasil diupdate', 'success');
                
                // Simulate disconnect after update
                setTimeout(() => {
                    disconnectFromDevice();
                }, 3000);
            }, 2000);
        }
        
        // Convert CSV to BIN
        function convertToBin() {
            showLoader();
            
            setTimeout(() => {
                downloadBinBtn.disabled = false;
                
                hideLoader();
                showToast('File CSV berhasil dikonversi ke .bin', 'success');
            }, 1500);
        }
        
        // Download BIN file
        function downloadBin() {
            // Create a dummy bin file for download
            const blob = new Blob([new Uint8Array(1024)], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hinsa_firmware.bin';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('File .bin berhasil diunduh', 'success');
        }
        
        // Copy firmware code
        function copyFirmwareCode() {
            const code = firmwareCodeEl.textContent;
            
            // Use clipboard API to copy text
            navigator.clipboard.writeText(code).then(() => {
                showToast('Kode firmware berhasil disalin ke clipboard', 'success');
            }, () => {
                showToast('Gagal menyalin kode. Silakan coba lagi.', 'error');
            });
        }
        
        // Download firmware
        function downloadFirmware() {
            const code = firmwareCodeEl.textContent;
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hinsa_firmware.ino';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('File firmware berhasil diunduh', 'success');
        }
        
        // Save configuration
        function saveConfiguration() {
            showLoader();
            
            setTimeout(() => {
                // Generate and display firmware code
                firmwareCodeEl.textContent = generateFirmwareCode();
                
                hideLoader();
                showToast('Konfigurasi berhasil disimpan', 'success');
            }, 1500);
        }
        
        // Export to CSV
        function exportToCsv() {
            // Generate dummy data for export
            const data = generateDummyData();
            
            // Convert to CSV
            const headers = Object.keys(data[0]);
            const csvRows = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ];
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hinsa_data.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data berhasil diekspor ke CSV', 'success');
        }
        
        // Export to JSON
        function exportToJson() {
            // Generate dummy data for export
            const data = generateDummyData();
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hinsa_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Data berhasil diekspor ke JSON', 'success');
        }
        
        // Generate report
        function generateReport() {
            showLoader();
            
            setTimeout(() => {
                // Generate PDF report (simulated)
                const blob = new Blob(['Dummy PDF content'], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'hinsa_harvest_report.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                hideLoader();
                showToast('Laporan panen berhasil dibuat', 'success');
            }, 2000);
        }
        
        // Generate dummy data for export
        function generateDummyData() {
            const data = [];
            const today = new Date();
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                const day = 30 - i;
                const week = day <= 7 ? 1 : day <= 14 ? 2 : day <= 21 ? 3 : 4;
                const params = weekParameters[week];
                
                const ppm = params.ppmMin + Math.random() * (params.ppmMax - params.ppmMin);
                const ph = params.phMin + Math.random() * (params.phMax - params.phMin);
                const temp = 25 + Math.random() * 3;
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    time: date.toTimeString().split(' ')[0],
                    day: Math.min(day, 25),
                    ppm: ppm.toFixed(1),
                    ph: ph.toFixed(2),
                    temperature: temp.toFixed(1),
                    status: 'Normal'
                });
            }
            
            return data;
        }
        
        // Generate firmware code
        function generateFirmwareCode() {
            const ppmPin = document.getElementById('ppm-pin').value;
            const phPin = document.getElementById('ph-pin').value;
            const nutrientPin = document.getElementById('nutrient-pin').value;
            const phUpPin = document.getElementById('ph-up-pin').value;
            const phDownPin = document.getElementById('ph-down-pin').value;
            const tempPin = document.getElementById('temp-pin').value;
            const wifiSsid = document.getElementById('wifi-ssid').value || 'YourWiFiSSID';
            const wifiPassword = document.getElementById('wifi-password').value || 'YourWiFiPassword';
            
            return `/*
 * HINSA - Sistem Monitoring Hidroponik Cerdas
 * Firmware untuk ${selectedBoard.toUpperCase()}
 * 
 * Fitur:
 * - Monitoring PPM dan pH
 * - Kontrol otomatis nutrisi dan pH
 * - Web server untuk monitoring dan kontrol
 * - OTA update
 * - Notifikasi panen pada hari ke-25
 */

#include <WiFi.h>
#include <ESPAsyncWebServer.h>
#include <AsyncElegantOTA.h>
#include <ArduinoJson.h>
#include <EEPROM.h>

// Konfigurasi WiFi
const char* ssid = "${wifiSsid}";
const char* password = "${wifiPassword}";

// Pin Sensor
const int PPM_SENSOR_PIN = ${ppmPin};    // Pin analog untuk sensor PPM/TDS
const int PH_SENSOR_PIN = ${phPin};     // Pin analog untuk sensor pH
const int TEMP_SENSOR_PIN = ${tempPin};   // Pin untuk sensor suhu DS18B20

// Pin Relay
const int NUTRIENT_PUMP_PIN = ${nutrientPin}; // Pin untuk relay pompa nutrisi
const int PH_UP_PUMP_PIN = ${phUpPin};    // Pin untuk relay pompa pH up
const int PH_DOWN_PUMP_PIN = ${phDownPin};  // Pin untuk relay pompa pH down

// Alamat EEPROM
const int EEPROM_DAY_ADDR = 0;    // Alamat untuk menyimpan hari ke-
const int EEPROM_PPM_MIN_ADDR = 4;
const int EEPROM_PPM_MAX_ADDR = 8;
const int EEPROM_PH_MIN_ADDR = 12;
const int EEPROM_PH_MAX_ADDR = 16;
const int EEPROM_AUTO_MODE_ADDR = 20;

// Variabel global
AsyncWebServer server(80);
float currentPPM = 0.0;
float currentPH = 0.0;
float currentTemp = 0.0;
int currentDay = 1;
bool autoMode = true;

// Parameter optimal berdasarkan hari
float ppmMin = 400.0;
float ppmMax = 500.0;
float phMin = 5.5;
float phMax = 6.0;

// Status relay
bool nutrientPumpOn = false;
bool phUpPumpOn = false;
bool phDownPumpOn = false;

// Struktur data untuk log
struct LogEntry {
  unsigned long timestamp;
  float ppm;
  float ph;
  float temp;
};

const int MAX_LOG_ENTRIES = 288; // 24 jam dengan interval 5 menit
LogEntry dataLog[MAX_LOG_ENTRIES];
int logIndex = 0;

// Fungsi untuk membaca sensor PPM
float readPPM() {
  // Baca nilai analog dari sensor PPM/TDS
  int rawValue = analogRead(PPM_SENSOR_PIN);
  
  // Konversi nilai analog ke PPM (kalibrasi sesuai sensor)
  float voltage = rawValue * 3.3 / 4095.0;
  float ppm = (133.42 * voltage * voltage * voltage - 255.86 * voltage * voltage + 857.39 * voltage) * 0.5;
  
  return ppm;
}

// Fungsi untuk membaca sensor pH
float readPH() {
  // Baca nilai analog dari sensor pH
  int rawValue = analogRead(PH_SENSOR_PIN);
  
  // Konversi nilai analog ke pH (kalibrasi sesuai sensor)
  float voltage = rawValue * 3.3 / 4095.0;
  float ph = 3.5 * voltage;
  
  return ph;
}

// Fungsi untuk mengatur parameter berdasarkan hari
void updateParameters() {
  if (currentDay <= 7) {
    // Minggu 1
    ppmMin = 400.0;
    ppmMax = 500.0;
    phMin = 5.5;
    phMax = 6.0;
  } else if (currentDay <= 14) {
    // Minggu 2
    ppmMin = 600.0;
    ppmMax = 800.0;
    phMin = 5.8;
    phMax = 6.2;
  } else if (currentDay <= 21) {
    // Minggu 3
    ppmMin = 800.0;
    ppmMax = 1000.0;
    phMin = 6.0;
    phMax = 6.3;
  } else {
    // Minggu 4
    ppmMin = 1000.0;
    ppmMax = 1200.0;
    phMin = 6.0;
    phMax = 6.5;
  }
  
  // Simpan parameter ke EEPROM
  EEPROM.writeFloat(EEPROM_PPM_MIN_ADDR, ppmMin);
  EEPROM.writeFloat(EEPROM_PPM_MAX_ADDR, ppmMax);
  EEPROM.writeFloat(EEPROM_PH_MIN_ADDR, phMin);
  EEPROM.writeFloat(EEPROM_PH_MAX_ADDR, phMax);
  EEPROM.commit();
}

// Fungsi untuk mengontrol pompa berdasarkan pembacaan sensor
void controlPumps() {
  if (!autoMode) return;
  
  // Kontrol pompa nutrisi berdasarkan PPM
  if (currentPPM < ppmMin) {
    digitalWrite(NUTRIENT_PUMP_PIN, HIGH);
    nutrientPumpOn = true;
    delay(1000); // Aktifkan pompa selama 1 detik
    digitalWrite(NUTRIENT_PUMP_PIN, LOW);
    nutrientPumpOn = false;
  }
  
  // Kontrol pompa pH berdasarkan pH
  if (currentPH < phMin) {
    digitalWrite(PH_UP_PUMP_PIN, HIGH);
    phUpPumpOn = true;
    delay(500); // Aktifkan pompa selama 0.5 detik
    digitalWrite(PH_UP_PUMP_PIN, LOW);
    phUpPumpOn = false;
  } else if (currentPH > phMax) {
    digitalWrite(PH_DOWN_PUMP_PIN, HIGH);
    phDownPumpOn = true;
    delay(500); // Aktifkan pompa selama 0.5 detik
    digitalWrite(PH_DOWN_PUMP_PIN, LOW);
    phDownPumpOn = false;
  }
}

void setup() {
  Serial.begin(115200);
  
  // Inisialisasi EEPROM
  EEPROM.begin(32);
  
  // Inisialisasi pin relay
  pinMode(NUTRIENT_PUMP_PIN, OUTPUT);
  pinMode(PH_UP_PUMP_PIN, OUTPUT);
  pinMode(PH_DOWN_PUMP_PIN, OUTPUT);
  
  // Matikan semua relay
  digitalWrite(NUTRIENT_PUMP_PIN, LOW);
  digitalWrite(PH_UP_PUMP_PIN, LOW);
  digitalWrite(PH_DOWN_PUMP_PIN, LOW);
  
  // Load parameter dari EEPROM
  loadParameters();
  
  // Update parameter berdasarkan hari
  updateParameters();
  
  // Koneksi WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println();
  Serial.print("Connected! IP address: ");
  Serial.println(WiFi.localIP());
  
  // Setup web server
  setupServer();
  
  Serial.println("System ready!");
}

void loop() {
  // Baca sensor setiap 2 detik
  static unsigned long lastSensorRead = 0;
  if (millis() - lastSensorRead > 2000) {
    readSensors();
    lastSensorRead = millis();
  }
  
  // Increment hari setiap 24 jam
  static unsigned long lastDayIncrement = 0;
  if (millis() - lastDayIncrement > 86400000) { // 24 jam dalam milidetik
    if (currentDay < 25) {
      currentDay++;
      EEPROM.writeInt(EEPROM_DAY_ADDR, currentDay);
      EEPROM.commit();
      updateParameters();
    }
    lastDayIncrement = millis();
  }
}`;
        }
        
        // Render growth chart
        function renderGrowthChart() {
            const ctx = document.getElementById('growthChart').getContext('2d');
            
            const labels = Array.from({length: 25}, (_, i) => `Hari ${i+1}`);
            const ppmData = [];
            const phData = [];
            
            // Generate data based on optimal parameters
            for (let day = 1; day <= 25; day++) {
                let week = 1;
                if (day > 7 && day <= 14) week = 2;
                else if (day > 14 && day <= 21) week = 3;
                else if (day > 21) week = 4;
                
                const params = weekParameters[week];
                ppmData.push((params.ppmMin + params.ppmMax) / 2);
                phData.push((params.phMin + params.phMax) / 2);
            }
            
            growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'PPM Optimal',
                            data: ppmData,
                            borderColor: 'rgba(46, 125, 50, 1)',
                            backgroundColor: 'rgba(46, 125, 50, 0.2)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'pH Optimal',
                            data: phData,
                            borderColor: 'rgba(33, 150, 243, 1)',
                            backgroundColor: 'rgba(33, 150, 243, 0.2)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'PPM'
                            },
                            min: 300,
                            max: 1300
                        },
                        y1: {
                            position: 'right',
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'pH'
                            },
                            min: 5,
                            max: 7,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // Simulate sensor data
        function simulateSensorData() {
            // Get optimal ranges for current day
            let week = 1;
            if (currentDay > 7 && currentDay <= 14) week = 2;
            else if (currentDay > 14 && currentDay <= 21) week = 3;
            else if (currentDay > 21) week = 4;
            
            const params = weekParameters[week];
            
            // Generate random values within optimal range +/- some variation
            const ppmVariation = (params.ppmMax - params.ppmMin) * 0.2;
            const phVariation = (params.phMax - params.phMin) * 0.2;
            
            const ppmMid = (params.ppmMin + params.ppmMax) / 2;
            const phMid = (params.phMin + params.phMax) / 2;
            
            const ppm = ppmMid + (Math.random() * 2 - 1) * ppmVariation;
            const ph = phMid + (Math.random() * 2 - 1) * phVariation;
            const temp = 25 + (Math.random() * 2 - 1) * 2;
            
            // Update display
            currentPpmEl.textContent = ppm.toFixed(1);
            currentPhEl.textContent = ph.toFixed(2);
            currentTempEl.textContent = temp.toFixed(1) + 'C';
            
            // Update status
            updateSensorStatus(ppm, ph, temp, params);
            
            // Update data preview table
            updateDataPreviewTable();
        }
        
        // Update sensor status
        function updateSensorStatus(ppm, ph, temp, params) {
            // PPM status
            if (ppm < params.ppmMin) {
                ppmStatusEl.textContent = "Di bawah optimal";
                ppmStatusEl.className = "sensor-status status-warning";
            } else if (ppm > params.ppmMax) {
                ppmStatusEl.textContent = "Di atas optimal";
                ppmStatusEl.className = "sensor-status status-warning";
            } else {
                ppmStatusEl.textContent = "Optimal";
                ppmStatusEl.className = "sensor-status status-optimal";
            }
            
            // pH status
            if (ph < params.phMin) {
                phStatusEl.textContent = "Di bawah optimal";
                phStatusEl.className = "sensor-status status-warning";
            } else if (ph > params.phMax) {
                phStatusEl.textContent = "Di atas optimal";
                phStatusEl.className = "sensor-status status-warning";
            } else {
                phStatusEl.textContent = "Optimal";
                phStatusEl.className = "sensor-status status-optimal";
            }
            
            // Temperature status
            if (temp < 20) {
                tempStatusEl.textContent = "Terlalu dingin";
                tempStatusEl.className = "sensor-status status-warning";
            } else if (temp > 30) {
                tempStatusEl.textContent = "Terlalu panas";
                tempStatusEl.className = "sensor-status status-warning";
            } else {
                tempStatusEl.textContent = "Optimal";
                tempStatusEl.className = "sensor-status status-optimal";
            }
        }
        
        // Update data preview table
        function updateDataPreviewTable() {
            const data = generateDummyData().slice(0, 5);
            
            let tableHTML = '';
            for (const row of data) {
                tableHTML += `
                <tr>
                    <td>${row.date}</td>
                    <td>${row.time}</td>
                    <td>${row.day}</td>
                    <td>${row.ppm}</td>
                    <td>${row.ph}</td>
                    <td>${row.temperature}</td>
                    <td><span class="badge badge-success">${row.status}</span></td>
                </tr>`;
            }
            dataPreviewTableEl.innerHTML = tableHTML;
        }
        
        // Parse comma-separated input values
        function parseInputValues(input) {
            if (!input) return [];
            return input.split(',')
                .map(val => parseFloat(val.trim()))
                .filter(val => !isNaN(val));
        }
        
        // Calculate median
        function calculateMedian(arr) {
            const sorted = [...arr].sort((a, b) => a - b);
            const half = Math.floor(sorted.length / 2);
            if (sorted.length % 2) {
                return sorted[half];
            }
            return (sorted[half - 1] + sorted[half]) / 2;
        }
        
        // Show loader
        function showLoader() {
            loaderEl.style.display = 'flex';
        }
        
        // Hide loader
        function hideLoader() {
            loaderEl.style.display = 'none';
        }
        
        // Show toast message
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // Set icon based on type
            let icon = 'fa-check-circle';
            if (type === 'warning') icon = 'fa-exclamation-triangle';
            else if (type === 'error') icon = 'fa-times-circle';
            
            // Create toast content
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${type === 'success' ? 'Berhasil' : type === 'warning' ? 'Perhatian' : 'Error'}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <div class="toast-progress">
                    <div class="toast-progress-bar"></div>
                </div>
            `;
            
            // Add to container
            toastContainer.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
